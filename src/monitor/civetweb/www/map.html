<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Ros Web Example</title>

    <link rel="stylesheet" type="text/css" href="scripts/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="scripts/bootstrap.min.css" />
    <!-- <link rel="stylesheet" type="text/css" href="scripts/font-awesome.min.css" /> -->


    <script type="text/javascript" src="./scripts/three.js"></script>
    <script type="text/javascript" src="./scripts/eventemitter2.min.js"></script>
    <script type="text/javascript" src="./scripts/roslib.js"></script>
    <script type="text/javascript" src="./scripts/ros3d.js"></script>
    <script type="text/javascript" src="./scripts/jquery.min.js"></script>        
    <script type="text/javascript" src="./scripts/bootstrap.min.js"></script>      
    <script type="text/javascript" src="./scripts/jquery-ui.min.js"></script>
    <script type="text/javascript" src="./scripts/bootbox.min.js"></script>

    <script type="text/javascript" src="./js/dat.gui.js"></script>
    <script type="text/javascript" src="./scripts/map-moveLine.js"></script>



    <!-- ECharts单文件引入 -->
    <!-- <script src="http://echarts.baidu.com/build/dist/echarts-all.js"></script> -->

    <script type="text/javascript" src="./echarts/echarts.min.js"></script>


    <!-- <script type="text/javascript" src="./theme/gray.js"></script> -->

    <style>
        * {
            font-family: Verdana, Arial, sans-serif;
        }

        a:link {
            color: #000;
            text-decoration: none;
        }

        a:visited {
            color: #000;
        }

        a:hover {
            color: #33F;
        }

        .button {
            background: -webkit-linear-gradient(top, #008dfd 0, #0370ea 100%);
            border: 1px solid #076bd2;
            border-radius: 3px;
            color: #fff;
            display: none;
            font-size: 13px;
            font-weight: bold;
            line-height: 1.3;
            padding: 8px 25px;
            text-align: center;
            text-shadow: 1px 1px 1px #076bd2;
            letter-spacing: normal;
        }

        .center {
            padding: 10px;
            text-align: center;
        }

        .final {
            color: black;
            padding-right: 3px;
        }

        .cmd_err {
            color: red;
        }

        .info {
            font-size: 14px;
            text-align: center;
            color: #777;
            display: none;
        }

        .right {
            float: right;
        }

        .vcenter {
            display: inline-block;
            vertical-align: middle;
            float: none;
        }

        #headline {
            font-size: 40px;
            font-weight: 300;
        }

        #info {
            font-size: 20px;
            text-align: center;
            color: #777;
            visibility: hidden;
        }

        #results {
            font-size: 14px;
            font-weight: bold;
            border: 1px solid #ddd;
            padding: 15px;
            text-align: left;
            min-height: 100px;
        }

        .navbar-custom a {
            color: white;
            background-color: black;
        }

        #menu001.navbar-default .navbar-brand {
            color: rgba(119, 119, 119, 1);
        }

        #menu001.navbar-default {
            font-size: 20px;
            background-color: rgba(224, 224, 224, 1);
            border-width: 1px;
            border-radius: 4px;
        }

        #menu001.navbar-default .navbar-nav>li>a {
            color: rgba(119, 119, 119, 1);
            background-color: rgba(248, 248, 248, 0);
            padding-right: 50px;
        }

        #menu001.navbar-default .navbar-nav>li>a:hover,
        #menu001.navbar-default .navbar-nav>li>a:focus {
            color: rgba(51, 51, 51, 1);
            background-color: rgba(248, 248, 248, 0);
        }

        #menu001.navbar-default .navbar-nav>.active>a,
        #menu001.navbar-default .navbar-nav>.active>a:hover,
        #menu001.navbar-default .navbar-nav>.active>a:focus {
            color: rgba(85, 85, 85, 1);
            background-color: rgba(231, 231, 231, 1);
        }

        #menu001.navbar-default .navbar-toggle {
            border-color: #ddd;
        }

        #menu001.navbar-default .navbar-toggle:hover,
        #menu001.navbar-default .navbar-toggle:focus {
            background-color: #ddd;
        }

        #menu001.navbar-default .navbar-toggle .icon-bar {
            background-color: #888;
        }

        #menu001.navbar-default .navbar-toggle:hover .icon-bar,
        #menu001.navbar-default .navbar-toggle:focus .icon-bar {
            background-color: #888;
        }

        #robot-url {
            font-size: 25px;
        }

        #url {
            font-size: 25px;
        }

        #canvas_selectpoint {
            position: absolute;
            /* left: 0px;
            top: 0px; */
            /* margin: 20px; */
            /* width: 400px;
            height: 200px; */
            border: thin solid #aaaaaa;
        }

        #canvas_mousemove {
            position: absolute;
            /* left: 0px;
            top: 0px; */
            /* margin: 20px; */
            /* width: 400px;
            height: 200px; */
            border: thin solid #aaaaaa;
        }

        #canvas_map {
            position: absolute;
            /* left: 0px;
            top: 0px; */
            /* margin: 20px; */
            /* width: 400px;
            height: 200px; */
            border: thin solid #aaaaaa;
        }

        body {
            background-color: rgb(255, 255, 255);
        }

        .g {
            margin: 110px 20px 0px 20px;
            width: 100px;
            height: 30px;
            border-radius: 50%;
            background-color: #99f;
            border: 1px solid #f00;
            position: relative;
        }

        .g:before,
        .g:after {
            content: "";
            display: block;
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%;
            height: 0px;
            border-radius: 50%/15px;
            transition: height 1s;
        }

        .g:before {
            background: radial-gradient(100px 30px at 50% 100%, rgba(255, 0, 0, 0) 80%, rgba(255, 0, 0, .3) 100%);
            z-index: -1;
        }

        .g:after {
            background: radial-gradient(100px 30px at 50% 0%, rgba(255, 0, 0, 0) 80%, rgba(255, 0, 0, .3) 100%);
            z-index: 1;
        }

        .g:hover:before,
        .g:hover:after {
            height: 100px;
        }
    </style>
    <script type="text/javascript">

        var ros;
        var connected = false;


        var img_map;
        var map_width;
        var map_height;

        var moveLine;

        var data;


        var jq = $.noConflict();


        //////////////////init
        function init() {
            var temp;

            if (localStorage.robotUrl != undefined) {
                temp = localStorage.robotUrl;		// use the last robot address
            } else {
                temp = "ws://192.168.2.200:9090";  //guess at it
            }
            document.getElementById("robotUrlEntry").value = temp;

            showInfo("info_none");


        }
        ////////////////////connect///////////////////////

        function connect() {
            var connectButton;
            if (connected) {			// disconnect
                ros.close();
            } else {
                robotUrl = document.getElementById("robotUrlEntry").value.trim();
                if (robotUrl == '') {
                    bootbox.alert("Please supply the robot's URL and port");
                    return;
                }
                robotUrl = robotUrl.replace("https:", "wss:");
                robotUrl = robotUrl.replace("http:", "ws:");
                if ((robotUrl.slice(0, 5) != "wss://") && (robotUrl.slice(0, 4) != "ws://") &&
                    (robotUrl.charAt(robotUrl.length - 5) != ":")) {

                    var r = bootbox.alert
                        ("The robot's URL should begin with http, https, ws, or wss, " +
                            "and end with a port number, like ':9090'.");
                    return;
                }
                ros = new ROSLIB.Ros({						// Connecting to ROS.
                    url: robotUrl
                });

                //////////////listener

            }
            ///////////ros.on


            ros.on('connection', function () {
                localStorage.robotUrl = robotUrl;
                connectButton = document.getElementById("connectButton");
                connectButton.innerHTML = "Disconnect";
                connectButton.style.background = "#00cc00";    		// green
                connected = true;
                addLog('Connected to websocket server.');
                var listener_route = new ROSLIB.Topic({
                    ros: ros,
                    name: '/monitor/route_msg',
                    messageType: 'visualization_msgs/MarkerArray'
                });

                listener_route.subscribe(function (message) {
                    //console.log('Received message on ' + listener1.name + ': ' + message.header.seq);
                    var temp_points = [];
                    for (var i = 0; i < message.markers.length; i++) {
                        if (message.markers[i].ns == '/route_plan_point') {

                            //console.log(i);
                            //console.log(message.markers[i].points);
                            var arr = Object.values(message.markers[i].points);
                            temp_points.push.apply(temp_points, arr);
                            //temp_points.push(arr);


                        }

                    }
                    //console.log(temp_points);
                    if (temp_points.length > 0) {
                        data = [{
                            from: '起点',
                            to: '终点',
                            ref_points: temp_points
                        }];
                        moveLine.update({
                            //marker点半径
                            markerRadius: 5,
                            //marker点颜色,为空或null则默认取线条颜色
                            markerColor: null,
                            //线条类型 solid、dashed、dotted
                            lineType: 'solid',
                            //线条宽度
                            lineWidth: 2,
                            //线条颜色
                            colors: ['#F9815C', '#F8AB60', '#EDCC72', '#E2F194', '#94E08A', '#4ECDA5'],
                            //移动点半径
                            moveRadius: 3,
                            //移动点颜色
                            fillColor: '#fff',
                            //移动点阴影颜色
                            shadowColor: '#00ffff',
                            //移动点阴影大小
                            shadowBlur: 5,

                            mapWidth: img_map.width,
                            mapHeight: img_map.height,

                            data: data
                        });
                    } else {
                        data = [];
                        moveLine.update({
                            //marker点半径
                            markerRadius: 5,
                            //marker点颜色,为空或null则默认取线条颜色
                            markerColor: null,
                            //线条类型 solid、dashed、dotted
                            lineType: 'solid',
                            //线条宽度
                            lineWidth: 2,
                            //线条颜色
                            colors: ['#F9815C', '#F8AB60', '#EDCC72', '#E2F194', '#94E08A', '#4ECDA5'],
                            //移动点半径
                            moveRadius: 3,
                            //移动点颜色
                            fillColor: '#fff',
                            //移动点阴影颜色
                            shadowColor: '#00ffff',
                            //移动点阴影大小
                            shadowBlur: 5,

                            mapWidth: img_map.width,
                            mapHeight: img_map.height,

                            data: data
                        });

                        //clearScene();
                    }
                    //str_pretty2 = JSON.stringify(message.markers[0].points, null, 4);
                    //addLog(str_pretty2);
                    //jq("#test").html('<pre>' + str_pretty2 + '</pre>');
                    //listener1.unsubscribe();
                });
                var listener_agv = new ROSLIB.Topic({
                    ros: ros,
                    name: '/perception/rviz_obstacle_msg',
                    messageType: 'visualization_msgs/MarkerArray'
                });

                listener_agv.subscribe(function (message) {
                    var arr_agv, arr_obs;
                    for (var i = 0; i < message.markers.length; i++) {
                        if (message.markers[i].ns == '/per/agv_obstacle') {

                            arr_agv = Object.values(message.markers[i].points);
                        }
                        if (message.markers[i].ns == '/per/per_obstacle_2') {

                            arr_obs = Object.values(message.markers[i].points);
                        }

                    }
                    make_agv(arr_agv, arr_obs);
                });

                var listener_select_point_msg = new ROSLIB.Topic({
                    ros: ros,
                    name: '/monitor/select_point_info',
                    messageType: 'visualization_msgs/MarkerArray'
                });

                listener_select_point_msg.subscribe(function (message) {
                    clearScene();

                    for (var i = 0; i < message.markers.length; i++) {
                        if (message.markers[i].ns == 'ref_point Mark') {

                            add_target_point(message.markers[i].pose.position.x / Scaling - x_offset, y_offset - message.markers[i].pose.position.y / Scaling);
                        }

                    }

                });

                var listener_obs_lidar = new ROSLIB.Topic({
                    ros: ros,
                    name: '/perception/rviz_obstacle_cam_lidar_msg',
                    messageType: 'visualization_msgs/MarkerArray'
                });

                listener_obs_lidar.subscribe(function (message) {
                    var arr_obs = [];
                    for (var i = 0; i < message.markers.length; i++) {
                        if (message.markers[i].ns == '/per/lidar_obstacle_fusion' && message.markers[i].points.length > 3) {
                            //arr_obs.push(Object.values(message.markers[i].points));
                            arr_obs.push(message.markers[i].points);
                        }
                    }
                    make_obs_lidar(arr_obs);
                });

                var listener_fusion_msg = new ROSLIB.Topic({
                    ros: ros,
                    name: '/localization/fusion_msg',
                    messageType: 'location_msgs/FusionDataInfo'
                });

                listener_fusion_msg.subscribe(function (message) {
                    //var timestamp = parseInt(message.header.stamp.secs + '' + message.header.stamp.nsecs.toString().substring(0, 3));
                    var timestamp = (message.header.stamp.secs * 1000) + parseInt(message.header.stamp.nsecs / 1000000);

                    chart1_count++;

                    if (chart1_count > 9) {
                        chart1_count = 0;

                        chart_count++;
                        if (chart_count > 2000) {
                            chart_linear_data1.shift();
                            chart_linear_data2.shift();
                            chart_yaw_data.shift();
                        }
                        chart_linear_data1.push({
                            name: timestamp,
                            value: [timestamp, message.velocity.linear.x]
                        });

                        chart_linear_data2.push({
                            name: timestamp,
                            value: [timestamp, message.velocity.linear.y]
                        });

                        chart_yaw_data.push({
                            name: timestamp,
                            value: [timestamp, message.yaw]
                        });
                    }

                });


                var listener = new ROSLIB.Topic({
                    ros: ros,
                    name: '/monitor/hmi_control_ad',
                    messageType: 'hmi_msgs/HMIControlAD'
                });

                listener.subscribe(function (message) {
                    //console.log('Received message on ' + listener1.name + ': ' + message.header.seq);
                    str_pretty = JSON.stringify(message, null, 4);
                    addLog(str_pretty);
                    //jq("#test2").html('<pre>' + str_pretty + '</pre>');
                    // var value = (message.CMD_Type + '').split(',');
                    // option.series[0].data[0].value = value;
                    // myChart.setOption(option, true);
                    //SetOptions(data);
                    //listener1.unsubscribe();
                });

                //svr
                // var addTwoIntsClient = new ROSLIB.Service({
                //     ros: ros,
                //     name: '/rosapi/get_param_names',
                //     serviceType: 'rosapi::GetParamNames'
                // });

                // var request = new ROSLIB.ServiceRequest({

                // });

                // addTwoIntsClient.callService(request, function (result) {
                //     console.log('Result for service call on '
                //         + addTwoIntsClient.name
                //         + ': '
                //         + JSON.stringify(result, null, 2));
                // });
            });
            ros.on('error', function (error) {
                addLog(error);
                //say('Darn. We failed to connect.');
                //none of the following work... 
                //alert (error.stack);
                //alert (error.message);
                //alert (JSON.stringify(error));
                bootbox.alert('Error connecting to websocket server. ');
            });
            ros.on('close', function () {
                if (connected) {			// throw away a second call
                    connected = false;
                    connectButton = document.getElementById("connectButton");
                    connectButton.style.background = "#006dcc";
                    connectButton.innerHTML = "Connect"
                    addLog('Connection to websocket server closed.');
                }
            });
        }
        ////////////showInfo///////////////////////////
        function showInfo(s) {
            if (s) {
                for (var child = info.firstChild; child; child = child.nextSibling) {
                    if (child.style) {
                        child.style.display = child.id == s ? 'inline' : 'none';
                    }
                }
                info.style.visibility = 'visible';
            } else {
                info.style.visibility = 'hidden';
            }
        }
        function addLog(text, textColor) {
            var table = document.getElementById("commandLog");
            var row = table.insertRow(0);
            var cell1 = row.insertCell(0);
            if (textColor) {
                cell1.style.color = "red";
            }
            cell1.innerHTML = text;
        }
        ////////////////////////////////////////////////////
        jq(document).ready(function () {

            //map
            var mycanvas = document.getElementById('canvas_map');
            var ctx = mycanvas.getContext('2d');

            img_map = new Image();
            img_map.src = "./img/map.png";
            map_width = img_map.width;
            map_height = img_map.height;

            img_map.onload = function () {

                // 将图片画到canvas上面上去！
                mycanvas.width = img_map.width;
                mycanvas.height = img_map.height;

                ctx.fillStyle = '#118215';
                ctx.fillRect(0, 0, img_map.width, img_map.height);


                ctx.drawImage(img_map, 0, 0, img_map.width, img_map.height);
                var imgData = ctx.getImageData(0, 0, mycanvas.width, mycanvas.height);

                ctx.putImageData(imgData, 0, 0);

                //改变其他canvas大小
                var can1 = document.getElementById('canvas_selectpoint');
                //var ctx1 = can1.getContext('2d');
                //var imgData1 = ctx1.getImageData(0, 0, can1.width, can1.height);
                can1.width = img_map.width;
                can1.height = img_map.height;
                //ctx1.putImageData(imgData1, 0, 0);

                var can2 = document.getElementById('canvas_mousemove');
                //var ctx2 = can2.getContext('2d');
                //var imgData2 = ctx2.getImageData(0, 0, can2.width, can2.height);
                can2.width = img_map.width;
                can2.height = img_map.height;
                //ctx2.putImageData(imgData2, 0, 0);

                can2 = document.getElementById('canvas_refline');
                can2.width = img_map.width;
                can2.height = img_map.height;

                can2 = document.getElementById('canvas_refline_move');
                can2.width = img_map.width;
                can2.height = img_map.height;

                can2 = document.getElementById('canvas_agv');
                can2.width = img_map.width;
                can2.height = img_map.height;

                can2 = document.getElementById('canvas_obstacle');
                can2.width = img_map.width;
                can2.height = img_map.height;

                map_width = img_map.width;
                map_height = img_map.height;
            }

            jq("#btn1").click(function () {
                if (!connected) {
                    showInfo("info_no_connect");
                    return;
                }
                showInfo("info_none");
                bootbox.confirm({
                    message: "确定要发送[" + jq("#HmiControlAD").find("option:selected").text() + "]命令?",
                    buttons: {
                        confirm: {
                            label: '确认',
                            className: 'btn-success'
                        },
                        cancel: {
                            label: '取消',
                            className: 'btn-danger'
                        }
                    },
                    callback: function (result) {
                        if (result) {
                            var cmdVel = new ROSLIB.Topic({
                                ros: ros,
                                name: '/monitor/hmi_control_ad',
                                messageType: 'hmi_msgs/HMIControlAD'
                            });

                            var HmiControlAD = new ROSLIB.Message({
                                header: { frame_id: '/odom', stamp: 0, seq: 0 },
                                CMD_Type: parseInt(jq("#HmiControlAD").val().trim())
                            });
                            cmdVel.publish(HmiControlAD);
                        }
                    }
                });
            });


            jq("#btn2").click(function () {


            });
            jq("#btn3").click(function () {


            });
            jq("#btn4").click(function () {


            });


            moveLine = new MoveLine({
                //marker点半径
                markerRadius: 5,
                //marker点颜色,为空或null则默认取线条颜色
                markerColor: null,
                //线条类型 solid、dashed、dotted
                lineType: 'solid',
                //线条宽度
                lineWidth: 2,
                //线条颜色
                colors: ['#F9815C', '#F8AB60', '#EDCC72', '#E2F194', '#94E08A', '#4ECDA5'],
                //移动点半径
                moveRadius: 3,
                //移动点颜色
                fillColor: '#ff0000',
                //移动点阴影颜色
                shadowColor: '#00ffff',
                //移动点阴影大小
                shadowBlur: 5,

                mapWidth: img_map.width,
                mapHeight: img_map.height,

                data: data
            });



        });//jq ready




    </script>
</head>

<body onload="init()">




    <!--连接websocket-->
    <div class="container-fluid" id="my-gui-container">
        <form role="form" class="form-horizontal" autocomplete="on" onsubmit="connect()">
            <div id="robot-url" class="form-group form-group-lg">
                <label for="robotUrlEntry" class="control-label col-xs-3">AGV URL:</label>
                <div class="col-xs-4">
                    <input type="url" name="url" id="robotUrlEntry" class="form-control input-lg" placeholder="ws://"
                        value="ws://192.168.2.200:9090" />
                </div>
                <div class="col-xs-3">
                    <button type="button" id="connectButton" class="btn btn-primary btn-lg" style="font-size:25"
                        onclick="connect()">
                        <strong>Connect</strong></button>
                </div>
            </div>
        </form>
    </div>
    <div class="container-fluid">
        <form role="form" class="form-horizontal" autocomplete="on" onsubmit="connect()">
            <div id="robot-url" class="form-group form-group-lg">
                <label for="HmiControlAD" class="control-label col-xs-3">HmiControlAD:</label>
                <div class="col-xs-4">
                    <select id="HmiControlAD" class="form-control input-lg">
                        <option value="0">NULL(0)</option>
                        <option value="1">Start Planning(1)</option>
                        <option value="2">Lift Up(2)</option>
                        <option value="3">Lift Down(3)</option>
                        <option value="4">Charging(4)</option>
                        <option value="5">Stop Charge(5)</option>
                        <option value="6">Stop(6)</option>
                        <option value="7">Reset(7)</option>
                        <option value="8">Task Pause(8)</option>
                        <option value="9">Task continue(9)</option>
                        <option value="10">Task Cancel(10)</option>
                        <option value="11">Parking Steadily(11)</option>
                        <option value="12">Slip stop(12)</option>
                        <option value="21">higo Power Control(21)</option>
                        <option value="22">Ultrasound Controller 1 Power(22)</option>
                        <option value="23">Ultrasound Controller 2 Power(23)</option>
                        <option value="24">Ultrasound Controller 3 Power(24)</option>
                        <option value="25">Ultrasound Controller 4 Power(25)</option>
                        <option value="26">Navigation Power Control(26)</option>
                        <option value="27">front radar power control(27)</option>
                        <option value="28">back radar Power control(28)</option>
                        <option value="29">4G Module Power Control(29)</option>
                        <option value="30">Switch Power Control(30)</option>
                        <option value="31">camera Power control(31)</option>
                    </select>
                </div>
                <div class="col-xs-2">
                    <button type="button" id="btn1" class="btn btn-primary btn-lg" style="font-size:25">
                        <strong>HmiControlAD</strong></button>
                </div>
                <!-- <div class="col-xs-4">
                    <label for="btn2" class="control-label col-xs-3">快捷按钮:</label></div> -->
                <button type="button" id="btn2" class="btn btn-info btn-lg" style="font-size:25">
                    <strong>车辆启动</strong></button>
                <button type="button" id="btn3" class="btn btn-danger btn-lg" style="font-size:25">
                    <strong>急停</strong></button>
                <button type="button" id="btn4" class="btn btn-warning btn-lg" style="font-size:25">
                    <strong>滑停</strong></button>

            </div>
        </form>
    </div>

    <div class="container-fluid">

        <div class="row">
            <div id="div_charts" class="col-xs-4"
                style="border: 1px solid black;text-align:center;width: 49%;height:920px;">
                <div id="chart1" style="height: 30%"></div>
                <div id="chart2" style="height: 30%"></div>
                <div id="chart3"></div>
            </div>
            <div id="box" class="col-xs-4" style="text-align:left;width: 49%;height:920px;">


                <canvas id="canvas_map" width="10" height="400" style="border: 1px solid black;"></canvas>
                <canvas id="canvas_refline" width="800" height="400"
                    style="border: 1px solid black;position: absolute;"></canvas>
                <canvas id="canvas_refline_move" width="800" height="400"
                    style="border: 1px solid black;position: absolute;"></canvas>
                <canvas id="canvas_agv" width="800" height="400"
                    style="border: 1px solid black;position: absolute;"></canvas>
                <canvas id="canvas_obstacle" width="800" height="400"
                    style="border: 1px solid black;position: absolute;"></canvas>
                <canvas id="canvas_three" width="920" height="920"
                    style="border: 1px solid black;;position: absolute;"></canvas>
                <canvas id="canvas_selectpoint" width="800" height="400" style="border: 1px solid black;"></canvas>
                <canvas id="canvas_mousemove" width="800" height="400" style="border: 1px solid black;"></canvas>




            </div>


            <!-- <div id="container" class="col-xs-4" style="text-align:center;width: 50%;height:400px;"> 
            </div> -->

        </div>

    </div>

    <div id="info">
        <p id="info_none"><br><br></p>
        <p id="info_no_connect">请先连接websocket服务</p>
        <p id="info_upgrade">This browser doesn't support the Web Speech API. Use <a
                href="//www.google.com/chrome">Chrome</a> version 25 or later.</p>
    </div>




    <div id="results">
        Command Log:
        <div style="height: 100px; overflow: auto;">
            <table id="commandLog">
            </table>
        </div>
        <br>
    </div>
    <p>
        Run the following commands in the terminal then refresh this page.
    </p>
    <ol>
        <li><tt>roslaunch rosbridge_server rosbridge_websocket.launch</tt></li>
        <li><tt>rosrun tf2_web_republisher tf2_web_republisher</tt></li>
        <li><tt>cd /home/higo/work/superg_agv/monitor/civetweb/www/</tt></li>
        <li><tt>./civetweb</tt></li>

    </ol>
    <script type="text/javascript">

    </script>
    <script>
        ; (function (window) {
            window.G = {};
            function bindEvent(obj, event, fn) {
                if (obj.attachEvent) { //ie
                    obj.attachEvent('on' + event, function () {
                        fn.call(obj);
                    });
                } else {
                    //chrome&ff
                    obj.addEventListener(event, fn, false);
                }
            }

            G.getPos = function (dom) {
                var oPos = { x: 0, y: 0 };
                bindEvent(dom, 'mousemove', function (ev) {
                    var oEvent = ev || event, x, y;
                    var mousePos = mouseCoords(ev);
                    // if (oEvent.pageX || oEvent.pageY) {
                    //     x = oEvent.pageX;
                    //     y = oEvent.pageY;
                    // } else {
                    //     x = oEvent.clientX + document.body.scrollLeft || document.documentElement.scrollLeft;
                    //     y = oEvent.clientX + document.body.scrollTop || document.documentElement.scrollTop;
                    // }
                    // x -= dom.offsetLeft;
                    // y -= dom.offsetTop;
                    // oPos.x = x;
                    // oPos.y = y;
                    oPos.x = mousePos.x;
                    oPos.y = mousePos.y;
                });
                return oPos;
            };

        })(window);
    </script>
    <script>

        var x_offset = -368;
        var y_offset = 916;
        var Scaling = 0.133; //0.138
        window.onload = function () {

            // var oCanvas = document.getElementById('can'),
            var oCanvas = document.querySelector("#canvas_mousemove"),
                oGc = oCanvas.getContext('2d'),

                width = oCanvas.width, height = oCanvas.height,
                oInfo,// = document.querySelector("#info1"),
                oPos;
            //oGc.translate(250, 250);
            oPos = G.getPos(oCanvas);

            oCanvas.addEventListener("mousemove", function () {

                oGc.clearRect(0, 0, width, height);
                oGc.beginPath();
                oGc.moveTo(oPos.x, 0);
                oGc.lineTo(oPos.x, height);
                oGc.moveTo(0, oPos.y);
                oGc.lineTo(width, oPos.y);
                oGc.closePath();
                oGc.strokeStyle = '#09f';
                oGc.stroke();
                oGc.strokeStyle = '#ff0000';

                if (oPos.x > width / 2) {
                    oGc.textAlign = 'right';//:center,left,right
                } else
                    oGc.textAlign = 'left';//:center,left,right

                if (oPos.y > height / 2)
                    oGc.textBaseline = 'bottom';
                else
                    oGc.textBaseline = 'top';
                oGc.font = 'bold 20px Arial';

                oGc.fillStyle = '#00ffff';

                oGc.fillText(((oPos.x + x_offset) * Scaling).toFixed(2) + ',' + ((y_offset - oPos.y) * Scaling).toFixed(2), oPos.x, oPos.y);
                oGc.strokeText(((oPos.x + x_offset) * Scaling).toFixed(2) + ',' + ((y_offset - oPos.y) * Scaling).toFixed(2), oPos.x, oPos.y);


                //oInfo.innerHTML = '鼠标的当前坐标是:(' + oPos.x + ',' + oPos.y + ')';
            }, false);



        }

        var options = {
            //marker点半径
            markerRadius: 5,
            //marker点颜色,为空或null则默认取线条颜色
            markerColor: null,
            //线条类型 solid、dashed、dotted
            lineType: 'solid',
            //线条宽度
            lineWidth: 2,
            //线条颜色
            colors: ['#F9815C', '#F8AB60', '#EDCC72', '#E2F194', '#94E08A', '#4ECDA5'],
            //移动点半径
            moveRadius: 3,
            //移动点颜色
            fillColor: '#ff0000',
            //移动点阴影颜色
            shadowColor: '#00ffff',
            //移动点阴影大小
            shadowBlur: 5,

            mapWidth: map_width,
            mapHeight: map_height,

            data: data
        };

        function finished() {
            addLog(options);
        }


        var gui = new dat.GUI({
            autoPlace: true,
            nameMap: {
                moveRadius: '移动点半径',
                fillColor: '移动点颜色',
                shadowColor: '移动点阴影颜色',
                shadowBlur: '移动点阴影大小',
            }
        });

        // var customContainer = document.getElementById('body');
        // customContainer.appendChild(gui.domElement);


        finished();
        gui.add(options, 'moveRadius', 1, 10).step(1).onFinishChange(finished);
        gui.addColor(options, 'fillColor').onChange(finished);
        gui.addColor(options, 'shadowColor').onChange(finished);
        gui.add(options, 'shadowBlur', 0, 20).step(1).onChange(finished);
        gui.closed = true;

        function GetRandomNum(Min, Max) {
            var Range = Max - Min;
            var Rand = Math.random();
            return (Min + Math.round(Rand * Range));
        }

        function mouseCoords(ev) {
            var e = event || window.event;
            var x = e.offsetX || e.layerX;
            var y = e.offsetY || e.layerY;
            return { x, y };
        }

        var globl_w = map_width;
        var globl_h = map_height;
        makerect(0, 0, globl_w, globl_w);

        //鼠标点击生成圆
        jq("#canvas_mousemove").click(function (e) {
            var ev = ev || window.event;
            var mousePos = mouseCoords(ev);
            mousePosX = mousePos.x;
            mousePosY = mousePos.y;
            console.log(mousePosX);
            console.log(mousePosY);
            makearc(mousePosX, mousePosY, GetRandomNum(4, 4), 0, 180, 'red');
            //发送ROS命令
            if (!connected) {
                showInfo("info_no_connect");
                return;
            }

            // var cmdVel = new ROSLIB.Topic({
            //     ros: ros,
            //     name: '/clicked_point',
            //     messageType: 'geometry_msgs/PointStamped'
            // });

            // var message = new ROSLIB.Message({
            //     header: { frame_id: '/odom', stamp: 0, seq: 0 },
            //     point: {
            //         x: ((mousePosX + x_offset) * Scaling),
            //         y: ((y_offset - mousePosY) * Scaling),
            //         z: 0.0
            //     }

            // });
            // cmdVel.publish(message);
        })

        function myAnimation() {
            ctx.clearRect(0, 0, map_width, map_height);
        }

        //生成圆
        function makearc(x, y, r, s, e, color) {
            var can = document.getElementById('canvas_selectpoint');
            var ctx = can.getContext("2d");
            ctx.clearRect(0, 0, map_width, map_height);
            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.arc(x, y, r, s, e);
            ctx.fill();

            ctx.font = 'bold 20px Arial';
            //oGc.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillStyle = '#ff0000';



            ctx.fillText('选点:(' + ((x + x_offset) * Scaling).toFixed(2) + ',' + ((y_offset - y) * Scaling).toFixed(2) + ')', 10, 50);
        }

        function makerect(x, y, w, h) {
            var can = document.getElementById('canvas_selectpoint');
            var ctx = can.getContext("2d");
            ctx.strokeRect(x, y, w, h);
        }
        //画AGV
        function make_agv(agv_points, obs_points) {
            var can = document.getElementById('canvas_agv');
            var ctx = can.getContext("2d");
            ctx.clearRect(0, 0, map_width, map_height);
            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.moveTo(agv_points[0].x / Scaling - x_offset, y_offset - agv_points[0].y / Scaling);
            ctx.lineTo(agv_points[1].x / Scaling - x_offset, y_offset - agv_points[1].y / Scaling);
            ctx.lineTo(agv_points[2].x / Scaling - x_offset, y_offset - agv_points[2].y / Scaling);
            ctx.lineTo(agv_points[3].x / Scaling - x_offset, y_offset - agv_points[3].y / Scaling);
            ctx.closePath();//闭合路径
            ctx.strokeStyle = 'red';
            ctx.stroke();

            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.moveTo(obs_points[5].x / Scaling - x_offset, y_offset - obs_points[5].y / Scaling);
            ctx.lineTo(obs_points[6].x / Scaling - x_offset, y_offset - obs_points[6].y / Scaling);
            ctx.lineTo(obs_points[7].x / Scaling - x_offset, y_offset - obs_points[7].y / Scaling);
            ctx.lineTo(obs_points[8].x / Scaling - x_offset, y_offset - obs_points[8].y / Scaling);
            ctx.closePath();//闭合路径
            ctx.strokeStyle = 'yellow';
            ctx.stroke();
        }

        function make_obs_lidar(obs_points) {
            var can = document.getElementById('canvas_obstacle');
            var ctx = can.getContext("2d");
            ctx.clearRect(0, 0, map_width, map_height);

            for (var i = 0; i < obs_points.length; i++) {
                ctx.beginPath();
                ctx.lineWidth = 2;
                ctx.moveTo(obs_points[i][0].x / Scaling - x_offset, y_offset - obs_points[i][0].y / Scaling);
                ctx.lineTo(obs_points[i][1].x / Scaling - x_offset, y_offset - obs_points[i][1].y / Scaling);
                ctx.lineTo(obs_points[i][2].x / Scaling - x_offset, y_offset - obs_points[i][2].y / Scaling);
                ctx.lineTo(obs_points[i][3].x / Scaling - x_offset, y_offset - obs_points[i][3].y / Scaling);
                ctx.closePath();//闭合路径
                ctx.strokeStyle = 'orange';
                ctx.stroke();
            }


        }

        //three/////////////////////////////////////////

        var angularSpeed = 0.5;
        var lastTime = 0;

        var list_target_point = [];
        var add_target_point = function (x, y) {
            this.x = x;
            this.y = y;

            // octa
            var octa = new THREE.OctahedronGeometry(10, 0);
            var material_octa = new THREE.MeshLambertMaterial({ color: '#7833aa' });
            var octa1 = new THREE.Mesh(octa, material_octa);
            octa1.position.set(x - w / 2, h / 2 - y, 0);
            //octa1.position.set(400, -400, 0);
            scene.add(octa1);
            list_target_point.push(octa1);
        }

        function animate() {
            // update
            var time = (new Date()).getTime();
            var timeDiff = time - lastTime;
            var angleChange = angularSpeed * timeDiff * 2 * Math.PI / 750;


            for (var i = 0; i < list_target_point.length; i++) {
                list_target_point[i].rotation.z += angleChange;
            }
            lastTime = time;

            // render
            renderer.render(scene, camera_Or);

            requestAnimationFrame(function () {
                animate();
            });
        }

        /**
 * 清除模型，模型中有 group 和 scene,需要进行判断
 * @param scene
 * @returns
 */
        function clearScene() {
            // 从scene中删除模型并释放内存
            if (list_target_point.length > 0) {
                for (var i = 0; i < list_target_point.length; i++) {
                    var currObj = list_target_point[i];

                    // 判断类型
                    if (currObj instanceof THREE.Scene) {
                        var children = currObj.children;
                        for (var i = 0; i < children.length; i++) {
                            deleteGroup(children[i]);
                        }
                    } else {
                        deleteGroup(currObj);
                    }
                    scene.remove(currObj);
                }
            }
        }

        // 删除group，释放内存
        function deleteGroup(group) {
            //console.log(group);
            if (!group) return;
            // 删除掉所有的模型组内的mesh
            group.traverse(function (item) {
                if (item instanceof THREE.Mesh) {
                    item.geometry.dispose(); // 删除几何体
                    item.material.dispose(); // 删除材质
                }
            });
        }
        // renderer

        var scene = new THREE.Scene();
        var h = 920,
            w = 920;

        //创建相机
        var camera_Or = new THREE.OrthographicCamera(w / -2, w / 2, h / 2, h / -2, 1, 1000);
        //camera_Or.position.z=5;
        camera_Or.position.set(0, 0, 100);
        camera_Or.lookAt(new THREE.Vector3(0, 0, 0))
        scene.add(camera_Or);

        var renderer = new THREE.WebGLRenderer({ canvas: canvas_three, alpha: true, antialias: true });
        renderer.setSize(w, h);

        //Ambient light
        var light = new THREE.AmbientLight(0xffffff, .5);

        var shadowLight = new THREE.DirectionalLight(0xffffff, 5);
        shadowLight.position.set(200, 200, 200);
        shadowLight.castShadow = true;

        var backLight = new THREE.DirectionalLight(0xffffff, .5);
        backLight.position.set(-100, -200, 50);
        backLight.castShadow = true;
        scene.add(backLight);
        scene.add(light);
        scene.add(shadowLight);

        // add_target_point(0, 0);
        // add_target_point(460, 460);
        // add_target_point(900, 0);
        // add_target_point(0, 900);
        // add_target_point(900, 900);

        animate();
            ///////////////////////////////////////////////////////////

    </script>
    <script type="text/javascript">
        var dom = document.getElementById("chart1");
        var myChart_linear = echarts.init(dom);


        var myChart_yaw = echarts.init(document.getElementById("chart2"));


        var app = {};
        var chart_linear_option = null;
        var chart_yaw_option = null;

        var chart1_count = 0;
        var chart_count = 0;

        function randomData() {
            now = now + 10;
            //var timestamp = now.getTime()
            return {
                name: now,
                value: [
                    now,
                    0
                ]
            }

        }
        var chart_linear_data1 = [];
        var chart_linear_data2 = [];

        var chart_yaw_data = [];

        // 给定某一时刻开始填充默认数据
        var oneMinutes = 30 * 1000;
        var now = new Date(2019, 1, 1).getTime();
        // for (var i = 0; i < 4000; i++) {
        //     var v = randomData();
        //     chart_linear_data1.push(v);
        //     chart_linear_data2.push(v);
        //     chart_yaw_data.push(v);
        // }

        chart_linear_option = {
            title: {
                text: '车辆线速度'
            },
            legend: {
                data: ['X速度', 'Y速度']
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            grid: [{
                left: 50,
                right: 50//,
                //height: '100%'
            }],
            toolbox: {
                feature: {
                    dataZoom: {
                        yAxisIndex: 'none'
                    },
                    restore: {},
                    saveAsImage: {}
                }
            },
            dataZoom: [{
                startValue: new Date()
            }, {
                type: 'inside'
            }],

            xAxis: {
                type: 'time',//'time',
                splitLine: {
                    show: false
                }
            },
            yAxis: {
                type: 'value',
                boundaryGap: ['10%', '10%'],
                splitLine: {
                    show: true
                }
            },
            series: [{
                name: 'X速度',
                type: 'line',
                smooth: true,
                showSymbol: false,
                hoverAnimation: false,
                data: chart_linear_data1

            }, {
                name: 'Y速度',
                type: 'line',
                smooth: true,
                showSymbol: false,
                hoverAnimation: false,
                data: chart_linear_data2
            }]
        };
        chart_yaw_option = {
            title: {
                text: '车辆角度'
            },

            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            grid: [{
                left: 50,
                right: 50//,
                //height: '100%'
            }],
            toolbox: {
                feature: {
                    dataZoom: {
                        yAxisIndex: 'none'
                    },
                    restore: {},
                    saveAsImage: {}
                }
            },
            dataZoom: [{
                startValue: new Date()
            }, {
                type: 'inside'
            }],

            xAxis: {
                type: 'time',//'time',
                splitLine: {
                    show: false
                }
            },
            yAxis: {
                type: 'value',
                boundaryGap: ['10%', '10%'],
                splitLine: {
                    show: true
                }
            },
            series: [{
                name: '角度',
                type: 'line',
                smooth: true,
                showSymbol: false,
                hoverAnimation: false,
                data: chart_yaw_data

            }]
        };

        setInterval(function () {

            myChart_linear.setOption({
                series: [{
                    data: chart_linear_data1
                }, {
                    data: chart_linear_data2
                }]
            });
            myChart_yaw.setOption({
                series: [{
                    data: chart_yaw_data
                }]
            });
        }, 1000);;
        if (chart_linear_option && typeof chart_linear_option === "object") {
            myChart_linear.setOption(chart_linear_option, true);
            myChart_yaw.setOption(chart_yaw_option, true);
        }
        window.onresize = function () {
            myChart_linear.resize();
            myChart_yaw.resize();
        }
    </script>
</body>

</html>